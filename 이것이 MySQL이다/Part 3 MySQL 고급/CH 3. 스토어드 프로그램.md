# Part 3 MySQL 고급

## CH 3. 스토어드 프로그램

### 1. 스토어드 프로시저

#### 1-1 스토어드 프로시저 개요

- 스토어드 프로시저란 MySQL에서 제공되는 프로그래밍 기능
- 쿼리문의 집합으로 어떠한 동작을 일괄 처리하기 위한 용도로, 자주 사용되는 쿼리를 모듈화 시켜서 필요할 때마다 호출

```SQL
DELIMITER $$
CREATE PROCEDURE 스토어드 프로시저이름(IN 도는 OUT 파라미터)
BEGIN
    -- SQL 프로그래밍 코딩
END $$
DELIMITER;
CALL 스토어드 프로시저이름();
```

##### 스토어드 프로시저의 수정과 삭제

- 수정은 `ALTER PROCEDURE`
- 삭제는 `DROP PROCEDURE`

##### 매개 변수의 사용

- 입력된 매개 변수는 스토어드 프로시저의 내부에서 다양한 용도로 사용
- 스토어드 프로시저에서 처리된 결과를 출력 매개 변수를 통해서 얻을 수도 있음

```SQL
-- 입력 매개 변수 지정 형식
IN 입력_매개 변수_이름 데이터_형식

-- 입력 매개 변수가 있는 스토어드 프로시저 실행
CALL 프로시저_이름(전달 값);

-- 출력 매개 변수를 지정 형식
OUT 출력_매개 변수_이름 데이터_형식
```

##### 스토어드 프로시저 내의 오류 처리

```SQL
DECLARE 액션 HANDLER FOR 오류조건 처리할_문장
```

#### 1-2 스토어드 프로시저의 특징

- MySQL의 성능을 향상시킬 수 있다.
- 유지관리가 간편하다.
- 모듈식 프로그래밍이 가능하다.
- 보안을 강화할 수 있다.

### 2. 스토어드 함수

<p>
    MySQL이 사용자가 원하는모든 함수를 제공하지 않으므로 필요하다면 사용자가 직접 함수를 만들어서 사용할 필요가 있다. 이렇게 사용자가 직접 만들어서 사용하는 함수를 스토어드 함수(Stored Function)라고 부른다.
</p>

```SQL
DELIMITER $$
CREATE FUNCTION 스토어드 함수이름(파라미터)
    RETURNS 반환형식
BEGIN
    -- 프로그래밍 코딩
    RETURN 반환값;
END $$
DELIMITER ;
SELECT 스토어드_함수이름();
```

- 스토어드 함수와 스토어드 프로시저의 차이점
  - 스토어드 프로시저의 파라미터와 달리 IN, OUT 등을 사용할 수 없다. 스토어드 함수의 파라미터는 모두 입력 파라미터로 사용된다.
  - 스토어드 함수는 RETURNS문으로 반환할 값의 데이터 형식을 지정하고, 본문 안에서는 RETURN문으로 하나의 값을 반환해야 한다. 스토어드 프로시저는 별도의 반환하는 구문이 없으며, 꼭 필요하다면 여러 개의 OUT 파라미터를 사용해서 값을 반환할 수 있었다.
  - 스토어드 프로시저는 CALL로 호출하지만, 스토어드 함수는 SELECT 문장 안에서 호출된다.
  - 스토어드 프로시저 안에서 SELECT문을 사용할 수 있지만, 스토어드 함수 안에서는 집합 결과를 반환하는 SELECT을 사용할 수 없다.
  - 스토어드 프로시저는 여러 SQL문이나 숫자 계산 등의 다양한 용도로 사용되지만, 스토어드 함수는 어떤 계산을 통해서 하나의 값을 반환하는데 주로 사용된다.

### 3. 커서

#### 3-1 커서의 개요

- 커서는 테이블에서 여러 개의 행을 쿼리한 후에, 쿼리의 결과인 행 집합을 한 행씩 처리하기 위한 방식
- 파일 처리 순서
  - 파일을 연다.(Open) 그러면 파일 포인터는 파일의 제일 시작(BOF, Begin Of File)을 가리키게 된다.
  - 처음 데이터를 읽는다. 포인터는 다음 행을 가리킨다.
  - 파일의 끝(EOF, End Of File)까지 반복한다.
    - 읽은 데이터 처리
    - 포인터는 다음 행으로 이동
  - 파일을 닫는다.(Close)

#### 3-2 커서의 처리 순서

![1](https://user-images.githubusercontent.com/38815618/96712631-639d8d00-13da-11eb-8fda-710929d3eb0c.PNG)

### 4. 트리거

#### 4-1 트리거의 개요

- 트리거는 제약 조건과 더불어서 데이터 무결성을 위해서 MySQL에서 사용할 수 있는 또 다른 기능
- 트리거란 테이블에 DML문(INSERT, UPDATE, DELETE 등)의 이벤트가 발생될 때 작동하는 데이터베이스 개체
- 트리거가 부착된 테이블에 이벤트(입력, 수정, 삭제)가 발생하면 자동으로 부착된 트리거가 실행

#### 4-2 트리거의 종류

- AFTER 트리거: 테이블에 이벤트 발생 후에 작동
- BEFORE 트리거: 테이블에 이벤트 발생 전에 작동

#### 4-3 트리거의 사용

```SQL
CREATE
    [DEFINER = {user|CURRENT_USER}]
    TRIGGER trigger_name
    trigger_time trigger_event
    ON tbl_name FOR EACH ROW
    [trigger_order]
    trigger_body

trigger_time: {BEFORE|AFTER}

trigger_event: {INSERT|UPDATE|DELETE}

trigger_order: {FOLLOWS|PRECEDES} other_trigger_name
```

##### 트리거가 생성하는 임시 테이블

![2](https://user-images.githubusercontent.com/38815618/96712634-64ceba00-13da-11eb-9b84-07abe6d3ba28.PNG)

<p>
    new 테이블은 INSERT와 UPDATE 작업 시에 변경할 새로운 데이터를 잠깐 저장해 둔다. 즉, 테이블에 INSERT나 UPDATE 트리거를 부착시켰다면 해당 테이블에 입력/변경될 새 값이 NEW 테이블에 저장된 후에 NEW 테이블의 값이 테이블에 입력/변경되는 것이다. 그러므로 NEW 테이블을 조작하면 입력되는 새로운 값을 다른 값으로 대치시킬 수 있다.
</p>

<p>
    그리고 OLD 테이블은 DELETE와 UPDATE 작업이 숭행되면 삭제 또는 변경되기 전의 예전 값이 저장된다.
</p>

#### 4-4 기타 트리거에 관한 내용

- 다중 트리거(Multiple Triggers): 하나의 테이블에 동일한 트리거가 여러 개 부착되어 있는 것
- 중첩 트리거(Nested Triggers): 트리거가 또 다른 트리거를 작동하는 것
- 하나의 테이블에 여러 개의 트리거가 부착되어 있다면 트리거의 작동 순서를 지정할 수 있음
